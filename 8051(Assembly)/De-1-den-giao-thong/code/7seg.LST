A51 MACRO ASSEMBLER  7SEG                                                                 05/03/2025 20:36:14 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN 7seg.OBJ
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE 7seg.asm SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

0000                   1     ORG 0000H        ; B·∫Øt ƒë·∫ßu ch∆∞∆°ng tr√¨nh t·ª´ ƒë·ªãa ch·ªâ 0000H
0000 8000              2     SJMP START_PROGRAM ; Nh·∫£y ƒë·∫øn nh√£n START_PROGRAM ƒë·ªÉ b·∫Øt ƒë·∫ßu th·ª±c thi ch∆∞∆°
                             ng tr√¨nh ch√≠nh
                       3     
                       4     ;-------------------------------------------------
                       5     ; Start Program
                       6     ;-------------------------------------------------
0002                   7     START_PROGRAM:
                       8         ; Initialize traffic light pins (P3.0‚ÄìP3.5)
0002 75B000            9         MOV P3, #00H        ; Thi·∫øt l·∫≠p t·∫•t c·∫£ c√°c ch√¢n c·ªßa Port 3 ·ªü m·ª©c th·∫•p
                              (t·∫Øt t·∫•t c·∫£ ƒë√®n giao th√¥ng ban ƒë·∫ßu)
                      10     
                      11     ;-------------------------------------------------
                      12     ; Main Loop
                      13     ;-------------------------------------------------
0005                  14     MAIN_LOOP:
                      15         ; Phase 1: NS Green (11s), EW Red (15s)
0005 780B             16         MOV R0, #11         ; G√°n gi√° tr·ªã 11 (gi√¢y) cho thanh ghi R0 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c
                              th·ªùi gian ƒë√®n xanh h∆∞·ªõng B·∫Øc-Nam
0007 790F             17         MOV R1, #15         ; G√°n gi√° tr·ªã 15 (gi√¢y) cho thanh ghi R1 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c
                              th·ªùi gian ƒë√®n ƒë·ªè h∆∞·ªõng ƒê√¥ng-T√¢y
0009 75B021           18         MOV P3, #100001B    ; Thi·∫øt l·∫≠p tr·∫°ng th√°i ƒë√®n: B·∫Øc-Nam Xanh (P3.2=1), ƒê√¥n
                             g-T√¢y ƒê·ªè (P3.3=1), c√°c ƒë√®n kh√°c t·∫Øt
000C 112B             19         ACALL PHASE_NS_GREEN; G·ªçi ch∆∞∆°ng tr√¨nh con PHASE_NS_GREEN ƒë·ªÉ th·ª±c hi·ªán giai
                              ƒëo·∫°n ƒë√®n xanh B·∫Øc-Nam
                      20     
                      21         ; NS Yellow (4s), EW Red (4s remaining)
000E 7804             22         MOV R0, #4          ; G√°n gi√° tr·ªã 4 (gi√¢y) cho thanh ghi R0 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c 
                             th·ªùi gian ƒë√®n v√†ng h∆∞·ªõng B·∫Øc-Nam
0010 7904             23         MOV R1, #4          ; G√°n gi√° tr·ªã 4 (gi√¢y) cho thanh ghi R1 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c 
                             th·ªùi gian ƒë√®n ƒë·ªè h∆∞·ªõng ƒê√¥ng-T√¢y (15 - 11 = 4 gi√¢y c√≤n l·∫°i)
0012 75B022           24         MOV P3, #100010B    ; Thi·∫øt l·∫≠p tr·∫°ng th√°i ƒë√®n: B·∫Øc-Nam V√†ng (P3.1=1), ƒê√¥
                             ng-T√¢y ƒê·ªè (P3.3=1), c√°c ƒë√®n kh√°c t·∫Øt
0015 113C             25         ACALL PHASE_NS_YELLOW; G·ªçi ch∆∞∆°ng tr√¨nh con PHASE_NS_YELLOW ƒë·ªÉ th·ª±c hi·ªán gi
                             ai ƒëo·∫°n ƒë√®n v√†ng B·∫Øc-Nam
                      26     
                      27         ; Phase 2: EW Green (11s), NS Red (15s)
0017 780F             28         MOV R0, #15         ; G√°n gi√° tr·ªã 15 (gi√¢y) cho thanh ghi R0 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c
                              th·ªùi gian ƒë√®n ƒë·ªè h∆∞·ªõng B·∫Øc-Nam
0019 790B             29         MOV R1, #11         ; G√°n gi√° tr·ªã 11 (gi√¢y) cho thanh ghi R1 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c
                              th·ªùi gian ƒë√®n xanh h∆∞·ªõng ƒê√¥ng-T√¢y
001B 75B00C           30         MOV P3, #001100B    ; Thi·∫øt l·∫≠p tr·∫°ng th√°i ƒë√®n: ƒê√¥ng-T√¢y Xanh (P3.5=1), B·∫
                             Øc-Nam ƒê·ªè (P3.0=1), c√°c ƒë√®n kh√°c t·∫Øt
001E 114D             31         ACALL PHASE_EW_GREEN; G·ªçi ch∆∞∆°ng tr√¨nh con PHASE_EW_GREEN ƒë·ªÉ th·ª±c hi·ªán giai
                              ƒëo·∫°n ƒë√®n xanh ƒê√¥ng-T√¢y
                      32     
                      33         ; EW Yellow (4s), NS Red (4s remaining)
0020 7804             34         MOV R0, #4          ; G√°n gi√° tr·ªã 4 (gi√¢y) cho thanh ghi R0 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c 
                             th·ªùi gian ƒë√®n ƒë·ªè h∆∞·ªõng B·∫Øc-Nam (15 - 11 = 4 gi√¢y c√≤n l·∫°i)
0022 7904             35         MOV R1, #4          ; G√°n gi√° tr·ªã 4 (gi√¢y) cho thanh ghi R1 ƒë·ªÉ ƒë·∫øm ng∆∞·ª£c 
                             th·ªùi gian ƒë√®n v√†ng h∆∞·ªõng ƒê√¥ng-T√¢y
0024 75B014           36         MOV P3, #010100B    ; Thi·∫øt l·∫≠p tr·∫°ng th√°i ƒë√®n: ƒê√¥ng-T√¢y V√†ng (P3.4=1), B·
                             ∫Øc-Nam ƒê·ªè (P3.0=1), c√°c ƒë√®n kh√°c t·∫Øt
0027 115E             37         ACALL PHASE_EW_YELLOW; G·ªçi ch∆∞∆°ng tr√¨nh con PHASE_EW_YELLOW ƒë·ªÉ th·ª±c hi·ªán gi
                             ai ƒëo·∫°n ƒë√®n v√†ng ƒê√¥ng-T√¢y
                      38     
0029 80DA             39         SJMP MAIN_LOOP    ; Nh·∫£y v·ªÅ ƒë·∫ßu v√≤ng l·∫∑p ch√≠nh ƒë·ªÉ ti·∫øp t·ª•c chu tr√¨nh
                      40     
A51 MACRO ASSEMBLER  7SEG                                                                 05/03/2025 20:36:14 PAGE     2

                      41     ;-------------------------------------------------
                      42     ; PHASE_NS_GREEN: NS Green + EW Red
                      43     ;-------------------------------------------------
002B                  44     PHASE_NS_GREEN:
002B 7F0B             45         MOV R7, #11         ; G√°n gi√° tr·ªã 11 cho thanh ghi R7, ƒë·∫°i di·ªán cho 11 l·∫ßn l
                             ·∫∑p (m·ªói l·∫ßn ~1 gi√¢y)
002D                  46     PHASE_NS_GREEN_LOOP:
002D C007             47         PUSH 07H            ; L∆∞u gi√° tr·ªã c·ªßa thanh ghi R7 v√†o stack
002F 7FFF             48         MOV R7, #255        ; G√°n gi√° tr·ªã 255 cho thanh ghi R7 ƒë·ªÉ t·∫°o v√≤ng l·∫∑p dela
                             y (ch·∫≠m h∆°n)
0031                  49     INNER_NS_GREEN:
0031 116F             50         ACALL DISPLAY_TIME  ; G·ªçi ch∆∞∆°ng tr√¨nh con DISPLAY_TIME ƒë·ªÉ hi·ªÉn th·ªã th·ªùi 
                             gian ƒë·∫øm ng∆∞·ª£c
0033 DFFC             51         DJNZ R7, INNER_NS_GREEN; Gi·∫£m R7 v√† nh·∫£y v·ªÅ INNER_NS_GREEN n·∫øu R7 ch∆∞a b·∫±ng
                              0 (t·∫°o delay)
0035 D007             52         POP 07H             ; Kh√¥i ph·ª•c gi√° tr·ªã c·ªßa thanh ghi R7 t·ª´ stack
0037 11B0             53         ACALL COUNTDOWN     ; G·ªçi ch∆∞∆°ng tr√¨nh con COUNTDOWN ƒë·ªÉ gi·∫£m gi√° tr·ªã ƒë·∫ø
                             m ng∆∞·ª£c (R0 v√† R1)
0039 DFF2             54         DJNZ R7, PHASE_NS_GREEN_LOOP; Gi·∫£m R7 v√† nh·∫£y v·ªÅ PHASE_NS_GREEN_LOOP n·∫øu R7 ch
                             ∆∞a b·∫±ng 0 (duy tr√¨ th·ªùi gian pha)
003B 22               55         RET                 ; Tr·ªü v·ªÅ ch∆∞∆°ng tr√¨nh g·ªçi
                      56     
                      57     ;-------------------------------------------------
                      58     ; PHASE_NS_YELLOW: NS Yellow + EW Red
                      59     ;-------------------------------------------------
003C                  60     PHASE_NS_YELLOW:
003C 7F04             61         MOV R7, #4          ; G√°n gi√° tr·ªã 4 cho thanh ghi R7, ƒë·∫°i di·ªán cho 4 l·∫ßn l·∫
                             ∑p (~4 gi√¢y)
003E                  62     PHASE_NS_YELLOW_LOOP:
003E C007             63         PUSH 07H
0040 7FFF             64         MOV R7, #255        ; ~1.5s delay loop (ch·∫≠m h∆°n)
0042                  65     INNER_NS_YELLOW:
0042 116F             66         ACALL DISPLAY_TIME
0044 DFFC             67         DJNZ R7, INNER_NS_YELLOW
0046 D007             68         POP 07H
0048 11B0             69         ACALL COUNTDOWN
004A DFF2             70         DJNZ R7, PHASE_NS_YELLOW_LOOP
004C 22               71         RET
                      72     
                      73     ;-------------------------------------------------
                      74     ; PHASE_EW_GREEN: EW Green + NS Red
                      75     ;-------------------------------------------------
004D                  76     PHASE_EW_GREEN:
004D 7F0B             77         MOV R7, #11         ; 11 seconds for EW green
004F                  78     PHASE_EW_GREEN_LOOP:
004F C007             79         PUSH 07H
0051 7FFF             80         MOV R7, #255        ; ~1.5s delay loop (ch·∫≠m h∆°n)
0053                  81     INNER_EW_GREEN:
0053 116F             82         ACALL DISPLAY_TIME
0055 DFFC             83         DJNZ R7, INNER_EW_GREEN
0057 D007             84         POP 07H
0059 11B0             85         ACALL COUNTDOWN
005B DFF2             86         DJNZ R7, PHASE_EW_GREEN_LOOP
005D 22               87         RET
                      88     
                      89     ;-------------------------------------------------
                      90     ; PHASE_EW_YELLOW: EW Yellow + NS Red
                      91     ;-------------------------------------------------
005E                  92     PHASE_EW_YELLOW:
005E 7F04             93         MOV R7, #4          ; 4 seconds for EW yellow
0060                  94     PHASE_EW_YELLOW_LOOP:
0060 C007             95         PUSH 07H
0062 7FFF             96         MOV R7, #255        ; ~1.5s delay loop (ch·∫≠m h∆°n)
0064                  97     INNER_EW_YELLOW:
0064 116F             98         ACALL DISPLAY_TIME
0066 DFFC             99         DJNZ R7, INNER_EW_YELLOW
A51 MACRO ASSEMBLER  7SEG                                                                 05/03/2025 20:36:14 PAGE     3

0068 D007            100         POP 07H
006A 11B0            101         ACALL COUNTDOWN
006C DFF2            102         DJNZ R7, PHASE_EW_YELLOW_LOOP
006E 22              103         RET
                     104     
                     105     ;-------------------------------------------------
                     106     ; DISPLAY_TIME: Display on 4 LEDs (NS and EW)
                     107     ;-------------------------------------------------
006F                 108     DISPLAY_TIME:
                     109         ; NS countdown (R0) ‚Üí LED1 (tens), LED2 (units)
006F E8              110         MOV A, R0           ; Chuy·ªÉn gi√° tr·ªã c·ªßa R0 (th·ªùi gian NS c√≤n l·∫°i) v√†o tha
                             nh ghi A
0070 75F00A          111         MOV B, #10          ; G√°n gi√° tr·ªã 10 v√†o thanh ghi B ƒë·ªÉ th·ª±c hi·ªán ph√©p chia
0073 84              112         DIV AB              ; Chia A cho B. Th∆∞∆°ng (h√†ng ch·ª•c) ƒë∆∞·ª£c l∆∞u trong A, s·ªë
                              d∆∞ (h√†ng ƒë∆°n v·ªã) ƒë∆∞·ª£c l∆∞u trong B
0074 FA              113         MOV R2, A           ; L∆∞u th∆∞∆°ng (h√†ng ch·ª•c c·ªßa th·ªùi gian NS) v√†o thanh ghi 
                             R2
0075 ABF0            114         MOV R3, B           ; L∆∞u s·ªë d∆∞ (h√†ng ƒë∆°n v·ªã c·ªßa th·ªùi gian NS) v√†o thanh 
                             ghi R3
                     115     
                     116         ; EW countdown (R1) ‚Üí LED3 (tens), LED4 (units)
0077 E9              117         MOV A, R1           ; Chuy·ªÉn gi√° tr·ªã c·ªßa R1 (th·ªùi gian EW c√≤n l·∫°i) v√†o tha
                             nh ghi A
0078 75F00A          118         MOV B, #10          ; G√°n gi√° tr·ªã 10 v√†o thanh ghi B
007B 84              119         DIV AB              ; Chia A cho B. Th∆∞∆°ng (h√†ng ch·ª•c) v√†o A, s·ªë d∆∞ (h√†ng ƒë∆
                             °n v·ªã) v√†o B
007C FC              120         MOV R4, A           ; L∆∞u th∆∞∆°ng (h√†ng ch·ª•c c·ªßa th·ªùi gian EW) v√†o thanh ghi 
                             R4
007D ADF0            121         MOV R5, B           ; L∆∞u s·ªë d∆∞ (h√†ng ƒë∆°n v·ªã c·ªßa th·ªùi gian EW) v√†o thanh 
                             ghi R5
                     122     
                     123         ; LED1 (NS tens, R2)
007F 75800E          124         MOV P0, #0EH        ; Ch·ªçn LED 1 (gi·∫£ s·ª≠ P0 ƒëi·ªÅu khi·ªÉn ch√¢n ch·ªçn LED)
0082 901000          125         MOV DPTR, #SEGMENT_CODE; N·∫°p ƒë·ªãa ch·ªâ c·ªßa b·∫£ng m√£ LED 7 ƒëo·∫°n v√†o thanh g
                             hi con tr·ªè d·ªØ li·ªáu DPTR
0085 EA              126         MOV A, R2           ; Chuy·ªÉn gi√° tr·ªã h√†ng ch·ª•c c·ªßa th·ªùi gian NS (R2) v√†o t
                             hanh ghi A
0086 93              127         MOVC A, @A+DPTR     ; ƒê·ªçc m√£ 7 ƒëo·∫°n t∆∞∆°ng ·ª©ng t·ª´ b·∫£ng SEGMENT_CODE d·ª±a
                              tr√™n gi√° tr·ªã trong A
0087 F590            128         MOV P1, A           ; Xu·∫•t m√£ 7 ƒëo·∫°n ra Port 1 ƒë·ªÉ hi·ªÉn th·ªã tr√™n LED 1
0089 11B9            129         ACALL DELAY_2MS     ; G·ªçi ch∆∞∆°ng tr√¨nh con DELAY_2MS ƒë·ªÉ t·∫°o kho·∫£ng tr·ªÖ ng
                             ·∫Øn
                     130     
                     131         ; LED2 (NS units, R3)
008B 75800D          132         MOV P0, #0DH        ; Ch·ªçn LED 2
008E 901000          133         MOV DPTR, #SEGMENT_CODE
0091 EB              134         MOV A, R3           ; Chuy·ªÉn gi√° tr·ªã h√†ng ƒë∆°n v·ªã c·ªßa th·ªùi gian NS (R3) v√
                             †o A
0092 93              135         MOVC A, @A+DPTR
0093 F590            136         MOV P1, A
0095 11B9            137         ACALL DELAY_2MS
                     138     
                     139         ; LED3 (EW tens, R4)
0097 75800B          140         MOV P0, #0BH        ; Ch·ªçn LED 3
009A 901000          141         MOV DPTR, #SEGMENT_CODE
009D EC              142         MOV A, R4           ; Chuy·ªÉn gi√° tr·ªã h√†ng ch·ª•c c·ªßa th·ªùi gian EW (R4) v√†o A
009E 93              143         MOVC A, @A+DPTR
009F F590            144         MOV P1, A
00A1 11B9            145         ACALL DELAY_2MS
                     146     
                     147         ; LED4 (EW units, R5)
00A3 758007          148         MOV P0, #07H        ; Ch·ªçn LED 4
00A6 901000          149         MOV DPTR, #SEGMENT_CODE
00A9 ED              150         MOV A, R5           ; Chuy·ªÉn gi√° tr·ªã h√†ng ƒë∆°n v·ªã c·ªßa th·ªùi gian EW (R5) v√
                             †o A
00AA 93              151         MOVC A, @A+DPTR
A51 MACRO ASSEMBLER  7SEG                                                                 05/03/2025 20:36:14 PAGE     4

00AB F590            152         MOV P1, A
00AD 11B9            153         ACALL DELAY_2MS
                     154     
00AF 22              155         RET                 ; Tr·ªü v·ªÅ ch∆∞∆°ng tr√¨nh g·ªçi
                     156     
                     157     ;-------------------------------------------------
                     158     ; COUNTDOWN: Decrease R0 and R1 if non-zero
                     159     ;-------------------------------------------------
00B0                 160     COUNTDOWN:
                     161         ; NS countdown
00B0 E8              162         MOV A, R0           ; Chuy·ªÉn gi√° tr·ªã c·ªßa R0 v√†o A
00B1 6001            163         JZ SKIP_R0          ; N·∫øu A b·∫±ng 0 (R0 ƒë√£ v·ªÅ 0), nh·∫£y ƒë·∫øn SKIP_R0
00B3 18              164         DEC R0              ; Gi·∫£m gi√° tr·ªã c·ªßa R0 ƒëi 1
00B4                 165     SKIP_R0:
                     166         ; EW countdown
00B4 E9              167         MOV A, R1           ; Chuy·ªÉn gi√° tr·ªã c·ªßa R1 v√†o A
00B5 6001            168         JZ SKIP_R1          ; N·∫øu A b·∫±ng 0 (R1 ƒë√£ v·ªÅ 0), nh·∫£y ƒë·∫øn SKIP_R1
00B7 19              169         DEC R1              ; Gi·∫£m gi√° tr·ªã c·ªßa R1 ƒëi 1
00B8                 170     SKIP_R1:
00B8 22              171         RET                 ; Tr·ªü v·ªÅ ch∆∞∆°ng tr√¨nh g·ªçi
                     172     
                     173     ;-------------------------------------------------
                     174     ; DELAY ~2ms
                     175     ;-------------------------------------------------
00B9                 176     DELAY_2MS:
00B9 7EFF            177         MOV R6, #255        ; G√°n gi√° tr·ªã 255 cho R6 ƒë·ªÉ t·∫°o v√≤ng l·∫∑p delay
00BB DEFE            178         DJNZ R6, $          ; Gi·∫£m R6 v√† nh·∫£y v·ªÅ ƒë·ªãa ch·ªâ hi·ªán t·∫°i ($) n·∫øu R6 
                             ch∆∞a b·∫±ng 0 (t·∫°o delay)
00BD 22              179         RET                 ; Tr·ªü v·ªÅ ch∆∞∆°ng tr√¨nh g·ªçi
                     180     
                     181     ;-------------------------------------------------
                     182     ; 7-Segment Code Table
                     183     ;-------------------------------------------------
1000                 184     ORG 1000H               ; ƒê·∫∑t ƒë·ªãa ch·ªâ b·∫Øt ƒë·∫ßu cho b·∫£ng m√£ t·∫°i 1000H trong
                              b·ªô nh·ªõ ch∆∞∆°ng tr√¨nh
1000                 185     SEGMENT_CODE:
1000 3F065B4F        186         DB 3FH, 06H, 5BH, 4FH, 66H, 6DH, 7DH, 07H, 7FH, 6FH ; M√£ 7 ƒëo·∫°n cho c√°c s·ªë t·ª´ 
                             0 ƒë·∫øn 9 (anode chung)
1004 666D7D07                
1008 7F6F                    
                     187     END                     ; K·∫øt th√∫c ch∆∞∆°ng tr√¨nh Assembly
A51 MACRO ASSEMBLER  7SEG                                                                 05/03/2025 20:36:14 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E               T Y P E  V A L U E   ATTRIBUTES

B. . . . . . . . . .  D ADDR   00F0H   A   
COUNTDOWN. . . . . .  C ADDR   00B0H   A   
DELAY_2MS. . . . . .  C ADDR   00B9H   A   
DISPLAY_TIME . . . .  C ADDR   006FH   A   
INNER_EW_GREEN . . .  C ADDR   0053H   A   
INNER_EW_YELLOW. . .  C ADDR   0064H   A   
INNER_NS_GREEN . . .  C ADDR   0031H   A   
INNER_NS_YELLOW. . .  C ADDR   0042H   A   
MAIN_LOOP. . . . . .  C ADDR   0005H   A   
P0 . . . . . . . . .  D ADDR   0080H   A   
P1 . . . . . . . . .  D ADDR   0090H   A   
P3 . . . . . . . . .  D ADDR   00B0H   A   
PHASE_EW_GREEN . . .  C ADDR   004DH   A   
PHASE_EW_GREEN_LOOP.  C ADDR   004FH   A   
PHASE_EW_YELLOW. . .  C ADDR   005EH   A   
PHASE_EW_YELLOW_LOOP  C ADDR   0060H   A   
PHASE_NS_GREEN . . .  C ADDR   002BH   A   
PHASE_NS_GREEN_LOOP.  C ADDR   002DH   A   
PHASE_NS_YELLOW. . .  C ADDR   003CH   A   
PHASE_NS_YELLOW_LOOP  C ADDR   003EH   A   
SEGMENT_CODE . . . .  C ADDR   1000H   A   
SKIP_R0. . . . . . .  C ADDR   00B4H   A   
SKIP_R1. . . . . . .  C ADDR   00B8H   A   
START_PROGRAM. . . .  C ADDR   0002H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
